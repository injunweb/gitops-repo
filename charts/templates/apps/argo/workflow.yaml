{{- range $app := .Values.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ $app.name }}-workflow
  namespace: {{ $.Values.project }}
spec:
  serviceAccountName: {{ $app.name }}-sa
  entrypoint: build
  arguments:
    parameters:
      - name: sha
  volumes:
    - name: docker-config
      secret:
        secretName: registry-secret
  templates:
    - name: build
      dag:
        tasks:
          - name: build
            template: build-container

    - name: build-container
      container:
        image: gcr.io/kaniko-project/executor:latest
        args:
          - "--dockerfile=Dockerfile"
          - "--context=git://github.com/{{ $app.ghOwner }}/{{ $app.ghRepo }}.git"
          - "--destination=harbor.injunweb.com/injunweb/{{ $.Values.project }}-{{ $app.name }}:{{`{{workflow.parameters.sha}}`}}"
          - "--destination=harbor.injunweb.com/injunweb/{{ $.Values.project }}-{{ $app.name }}:latest"
        volumeMounts:
          - name: docker-config
            mountPath: /kaniko/.docker
        env:
          - name: GIT_USERNAME
            valueFrom:
              secretKeyRef:
                name: github-secret
                key: username
          - name: GIT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: github-secret
                key: token
{{- end }}
